name: End-to-End ML CI/CD Pipeline

on:
  push:
    branches:
      - main

jobs:

  ml-pipeline:
    runs-on: ubuntu-latest

    steps:

    # 1️⃣ Checkout Repository
    - name: Checkout Code
      uses: actions/checkout@v3

    # 2️⃣ Setup Python
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: 3.13

    # 3️⃣ Install Dependencies
    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    # 4️⃣ Run Data Preprocessing
    - name: Run Preprocessing
      run: python src/preprocess.py

    # 5️⃣ Train Model
    - name: Train Model
      run: python src/train.py

    # 6️⃣ Evaluate Model (Fails if below threshold)
    - name: Evaluate Model
      run: python src/evaluate.py

    # 7️⃣ Run Unit Tests
    - name: Run Unit Tests
      run: pytest

    # 8️⃣ Upload Trained Model as Artifact
    - name: Upload Model Artifact
      uses: actions/upload-artifact@v4
      with:
        name: trained-model
        path: models/model.pkl

    # 9️⃣ Build Docker Image
    - name: Build Docker Image
      run: docker build -t ml-app:latest .